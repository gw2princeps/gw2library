import { GetItemCommand } from "@aws-sdk/client-dynamodb";
import { NextApiRequest, NextApiResponse } from "next";
import { client } from "src/utils/dbclient";

export const config = {
  runtime: "nodejs",
};

const BUILDS = {
  thief: {
    name: "Super duper thief",
    optimizerSettingsLink:
      "http://localhost:3001/?m=fractals&v=0&data=XQAAAAJZSgAAAAAAAABA",
    description:
      'The <Specialization name="Daredevil" text="Power Daredevil"/> has great sustained DPS, great burst on stacked trash mobs, good single target burst, brings excellent crowd control and offers <Effect name="Stealth"/>, which paired with top tier mobility thanks to <Skill id="13025"/>, <Skill id="13002"/> and <Skill id="13064"/> can enable fast skips in T4s. <Specialization name="Daredevil"/> has a very simplistic rotation, which makes it fairly easy to play, but due to initiative and energy management, <Specialization name="Daredevil"/> becomes quite hard to master. \n\nIn fractals <Specialization name="Daredevil" text="Power Daredevil"/>  does have some drawbacks:\n\n1. First reason is <Trait id="1268"/>, which forces <Specialization name="Daredevil"/> to constantly flank to crit cap, unless you adjust your gear (with the current setup this isn\'t required if you run <Skill name="Signet of Agility"/>).\n2. While being a very strong build on a lot of T4s, <Specialization name="Daredevil" text="Power Daredevil"/> struggles to keep up with other power builds on CMs and it is reccomended to play <BuildLink build="Condi Specter" specialization="Specter"/> instead.\n3. Because of <Trait id="2047"/>, you may be pushing your teammates on fractals with <Instability name="Social Awkwardness"/> instability into deadly zones.\n\nThe build benefits from slaying potions such as <Item id="50082"/> and <Item name="Impact" type="Sigil"/>.\n\n|                                           |                                                                                           |\n| ----------------------------------------- | ----------------------------------------------------------------------------------------- |\n| <Trait id="1702" size="big" disableText/> | Critical Strikes trait. Heals you with % of damage dealt, useful if you can\'t stay alive. |\n| <Trait id="2023" size="big" disableText/> | Daredevil trait. Healing and condition cleanse on evade.                                  |\n| <Trait id="1964" size="big" disableText/> | Daredevil trait. Changes dodge to a dash, increasing your mobility. Also condi cleanses and grants <Boon name="Swiftness"/> |\n\nIf no one in your party can boonrip when the <Instability name="No Pain, No Gain"/> instability is present you can swap Deadly Arts for the Trickery line with the following traits:\n',
    character:
      '{"attributes":{"profession":"Thief","specialization":"Daredevil","data":{"Health":18985,"Armor":2361,"Power":3735.3,"Precision":2104,"Toughness":1243,"Vitality":1734,"Ferocity":1715,"Condition Damage":750,"Expertise":0,"Concentration":243,"Healing Power":0,"Agony Resistance":162,"Condition Duration":0,"Boon Duration":0.162,"Critical Chance":1.0457142857142858,"Critical Damage":2.6433333333333335,"Power Coefficient":2924,"Power2 Coefficient":0,"Burning Coefficient":0,"Bleeding Coefficient":0,"Poison Coefficient":0.94,"Torment Coefficient":0,"Confusion Coefficient":0,"Flat DPS":0,"Siphon Base Coefficient":139.75,"Effective Power":38071.99263012102,"NonCrit Effective Power":12819.780768682249,"Power DPS":42865.80918385594,"Power2 DPS":0,"Siphon DPS":139.75,"Bleeding Damage":96.3125,"Bleeding Stacks":0,"Bleeding DPS":0,"Burning Damage":355.421875,"Burning Stacks":0,"Burning DPS":0,"Confusion Damage":118.665625,"Confusion Stacks":0,"Confusion DPS":0,"Poison Damage":112.84375,"Poison Stacks":0.94,"Poison DPS":106.07312499999999,"Torment Damage":142.74375,"Torment Stacks":0,"Torment DPS":0,"Damage":43111.632308855944,"Effective Health":122360993.3869746,"Survivability":62206.91072037346,"Effective Healing":390,"Healing":390}},"armor":{"weight":"Medium","helmAffix":"Berserker","helmRuneId":24836,"helmRune":"Scholar","helmRuneCount":6,"helmInfusionId":49432,"shouldersAffix":"Dragon","shouldersRuneId":24836,"shouldersRune":"Scholar","shouldersRuneCount":6,"shouldersInfusionId":49432,"coatAffix":"Berserker","coatRuneId":24836,"coatRune":"Scholar","coatRuneCount":6,"coatInfusionId":49432,"glovesAffix":"Dragon","glovesRuneId":24836,"glovesRune":"Scholar","glovesRuneCount":6,"glovesInfusionId":49432,"leggingsAffix":"Berserker","leggingsRuneId":24836,"leggingsRune":"Scholar","leggingsRuneCount":6,"leggingsInfusionId":49432,"bootsAffix":"Dragon","bootsRuneId":24836,"bootsRune":"Scholar","bootsRuneCount":6,"bootsInfusionId":49432},"weapon":{"weapon1MainId":30698,"weapon1MainType":"Staff","weapon1MainSigil1Id":24615,"weapon1MainAffix":"Berserker","weapon1MainInfusion1Id":49432,"weapon1MainInfusion2Id":49432,"weapon1MainSigil2Id":24868,"weapon2MainId":30686,"weapon2MainType":"Short Bow","weapon2MainSigil1Id":24615,"weapon2MainAffix":"Berserker","weapon2MainInfusion1Id":49432,"weapon2MainInfusion2Id":49432,"weapon2MainSigil2Id":24868},"backAndTrinket":{"backItemAffix":"Berserker","backItemInfusion1Id":49432,"backItemInfusion2Id":49432,"amuletAffix":"Berserker","ring1Affix":"Berserker","ring1Infusion1Id":49432,"ring1Infusion2Id":49432,"ring1Infusion3Id":49432,"ring2Affix":"Berserker","ring2Infusion1Id":49432,"ring2Infusion2Id":49432,"ring2Infusion3Id":49432,"accessory1Affix":"Berserker","accessory1InfusionId":49432,"accessory2Affix":"Berserker","accessory2InfusionId":49432},"consumables":{"foodId":91805,"utilityId":50082},"skills":{"healId":13027,"utility1Id":13060,"utility2Id":13046,"utility3Id":13064,"eliteId":29516},"assumedBuffs":{"value":[{"id":"might","type":"Boon"},{"id":"fury","type":"Boon"},{"id":"protection","type":"Boon"},{"id":"vulnerability","type":"Condition"},{"id":"jade-bot","gw2id":96613,"type":"Item"},{"id":"omnipotion","gw2id":79722,"type":"Item"}]},"traits":{"selection":[[1245,1704,1269],[1268,1272,1904],[1933,1893,2047]],"lines":[28,35,7]}}',
    mdx: '/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    p: "p",\n    ol: "ol",\n    li: "li",\n    table: "table",\n    thead: "thead",\n    tr: "tr",\n    th: "th",\n    tbody: "tbody",\n    td: "td"\n  }, _provideComponents(), props.components), {Specialization, Effect, Skill, Trait, BuildLink, Instability, Item, Boon} = _components;\n  if (!Boon) _missingMdxReference("Boon", true);\n  if (!BuildLink) _missingMdxReference("BuildLink", true);\n  if (!Effect) _missingMdxReference("Effect", true);\n  if (!Instability) _missingMdxReference("Instability", true);\n  if (!Item) _missingMdxReference("Item", true);\n  if (!Skill) _missingMdxReference("Skill", true);\n  if (!Specialization) _missingMdxReference("Specialization", true);\n  if (!Trait) _missingMdxReference("Trait", true);\n  return _jsxs(_Fragment, {\n    children: [_jsxs(_components.p, {\n      children: ["The ", _jsx(Specialization, {\n        name: "Daredevil",\n        text: "Power Daredevil"\n      }), " has great sustained DPS, great burst on stacked trash mobs, good single target burst, brings excellent crowd control and offers ", _jsx(Effect, {\n        name: "Stealth"\n      }), ", which paired with top tier mobility thanks to ", _jsx(Skill, {\n        id: "13025",\n        id: "13025"\n      }), ", ", _jsx(Skill, {\n        id: "13002",\n        id: "13002"\n      }), " and ", _jsx(Skill, {\n        id: "13064",\n        id: "13064"\n      }), " can enable fast skips in T4s. ", _jsx(Specialization, {\n        name: "Daredevil"\n      }), " has a very simplistic rotation, which makes it fairly easy to play, but due to initiative and energy management, ", _jsx(Specialization, {\n        name: "Daredevil"\n      }), " becomes quite hard to master."]\n    }), "\\n", _jsxs(_components.p, {\n      children: ["In fractals ", _jsx(Specialization, {\n        name: "Daredevil",\n        text: "Power Daredevil"\n      }), "  does have some drawbacks:"]\n    }), "\\n", _jsxs(_components.ol, {\n      children: ["\\n", _jsxs(_components.li, {\n        children: ["First reason is ", _jsx(Trait, {\n          id: "1268",\n          id: "1268"\n        }), ", which forces ", _jsx(Specialization, {\n          name: "Daredevil"\n        }), " to constantly flank to crit cap, unless you adjust your gear (with the current setup this isn\'t required if you run ", _jsx(Skill, {\n          name: "Signet of Agility",\n          id: "13062"\n        }), ")."]\n      }), "\\n", _jsxs(_components.li, {\n        children: ["While being a very strong build on a lot of T4s, ", _jsx(Specialization, {\n          name: "Daredevil",\n          text: "Power Daredevil"\n        }), " struggles to keep up with other power builds on CMs and it is reccomended to play ", _jsx(BuildLink, {\n          build: "Condi Specter",\n          specialization: "Specter"\n        }), " instead."]\n      }), "\\n", _jsxs(_components.li, {\n        children: ["Because of ", _jsx(Trait, {\n          id: "2047",\n          id: "2047"\n        }), ", you may be pushing your teammates on fractals with ", _jsx(Instability, {\n          name: "Social Awkwardness"\n        }), " instability into deadly zones."]\n      }), "\\n"]\n    }), "\\n", _jsxs(_components.p, {\n      children: ["The build benefits from slaying potions such as ", _jsx(Item, {\n        id: "50082",\n        id: "50082"\n      }), " and ", _jsx(Item, {\n        name: "Impact",\n        type: "Sigil",\n        id: "24868"\n      }), "."]\n    }), "\\n", _jsxs(_components.table, {\n      children: [_jsx(_components.thead, {\n        children: _jsxs(_components.tr, {\n          children: [_jsx(_components.th, {}), _jsx(_components.th, {})]\n        })\n      }), _jsxs(_components.tbody, {\n        children: [_jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            children: _jsx(Trait, {\n              id: "1702",\n              size: "big",\n              disableText: true,\n              id: "1702"\n            })\n          }), _jsx(_components.td, {\n            children: "Critical Strikes trait. Heals you with % of damage dealt, useful if you can\'t stay alive."\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            children: _jsx(Trait, {\n              id: "2023",\n              size: "big",\n              disableText: true,\n              id: "2023"\n            })\n          }), _jsx(_components.td, {\n            children: "Daredevil trait. Healing and condition cleanse on evade."\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            children: _jsx(Trait, {\n              id: "1964",\n              size: "big",\n              disableText: true,\n              id: "1964"\n            })\n          }), _jsxs(_components.td, {\n            children: ["Daredevil trait. Changes dodge to a dash, increasing your mobility. Also condi cleanses and grants ", _jsx(Boon, {\n              name: "Swiftness"\n            })]\n          })]\n        })]\n      })]\n    }), "\\n", _jsxs(_components.p, {\n      children: ["If no one in your party can boonrip when the ", _jsx(Instability, {\n        name: "No Pain, No Gain"\n      }), " instability is present you can swap Deadly Arts for the Trickery line with the following traits:"]\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\nfunction _missingMdxReference(id, component) {\n  throw new Error("Expected " + (component ? "component" : "object") + " `" + id + "` to be defined: you likely forgot to import, pass, or provide it.");\n}\n',
    chatcode: "[&DQQcPSMbBznjMgAABDMAAPYyAAAIMwAATHMAAAAAAAAAAAAAAAAAAAAAAAA=]",
    timestamp: "2022-11-16T18:57:09.370Z",
  },
};

export default async function getBuild(
  req: NextApiRequest,
  res: NextApiResponse
) {
  if (req.method !== "GET") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  if (!req.query.buildid) {
    return res.status(400).json({ error: "Missing required fields" });
  }

  const buildid = req.query.buildid as string;
  if (buildid.length === 0) {
    return res.status(400).json({ error: "Missing required fields" });
  }

  const { Item: build } = await client.send(
    new GetItemCommand({
      TableName: process.env.TABLE_NAME,
      Key: {
        id: { S: buildid },
      },
    })
  );

  if (!build) {
    return res.status(404).json({ error: "Build not found" });
  }
  return res.status(200).json({
    name: build.name.S,
    mdx: build.mdx.S,
    chatcode: build.chatcode.S,
    timestamp: parseInt(build.timestamp.N || "-1", 10),
    character: JSON.parse(build.character.S || "{}"),
  });
}
